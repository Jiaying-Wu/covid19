---
title: "Examining COVID-19 data"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
    source_code: embed
    theme: sandstone
runtime: shiny
---

```{r setup, include=FALSE}
# knitr opts
knitr::opts_chunk$set(cache = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      echo = FALSE,
                      eval = TRUE
)
```

```{r libraryload}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(tsibble)
library(jsonlite)
library(gridExtra)
# remotes::install_github("ropenscilabs/ochRe")
library(ochRe)
library(forcats)
library(plotly)
library(DT)
#library(googlesheets)
library(ggrepel)
library(shiny)
```


```{r read-data}
# Nick Evershed's Guardian live data
dj <- fromJSON("https://interactive.guim.co.uk/docsdata/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE.json")
d <- dj[[1]]$updates 
d <- d %>% 
  rename(state=State, date=Date, cum_count = `Cumulative case count`, cum_deaths = `Cumulative deaths`,
         tests_neg = `Tests conducted (negative)`, tests_tot = `Tests conducted (total)`, 
         source = `Update Source`, under60 = `Under 60`, over60 = `Over 60`, 
         community = Community, travel = `Travel-related`, unknown = `Under investigation`, 
         notes = Notes) %>%
  mutate(date = dmy(date), cum_count = as.numeric(cum_count),
         #state = factor(state, levels = c("NSW", "VIC", "QLD", "SA", "WA", "ACT", "TAS", "NT")),
         cum_deaths = as.numeric(cum_deaths), tests_neg = as.numeric(tests_neg), 
         tests_tot = as.numeric(tests_tot)) %>%
  mutate(cum_count = replace_na(cum_count, 0), cum_deaths = replace_na(cum_deaths, 0)) %>%
  select(-Time) %>%
  distinct(date, state, .keep_all = TRUE)
#g <- gs_url("https://docs.google.com/spreadsheets/d/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE/htmlview#")
#dg <- read_read(g, )
```

```{r testing_data}
testing <- read_csv("data/covid-19-tests-country.csv")
oz_testing <- testing %>% filter(grepl("Australia", Entity)) %>%
  filter(Entity != "Australia")  %>%
  mutate(Entity = gsub("Australia - ", "", Entity)) %>%
  mutate(Entity = recode(Entity, "New South Wales"="NSW", 
                         "Victoria"="VIC",
                         "Queensland"="QLD", 
                        "Australian Capital Territory"="ACT", 
                        "South Australia"="SA", 
                        "Western Australia"="WA", 
                        "Tasmania"="TAS", 
                        "Northern Territory"="NT")) %>%
  rename(tests = `Total COVID-19 tests`, state=Entity) %>%
  select(state, tests)

# Update NSW data from the nice NSW news page with tables
url = "https://www.health.nsw.gov.au/news/Pages/20200327_00.aspx"
raw = xml2::read_html(url)
raw_nsw_tbl = raw %>%
  rvest::html_nodes(#xpath = #".//div[@id='ctl00_PlaceHolderMain_contentc1__ControlWrapper_RichHtmlField']/table") %>%
  "table") %>%                   
  rvest::html_table()
nsw_counts <- raw_nsw_tbl[[1]]  %>% 
  as_tibble() %>% 
  janitor::clean_names() %>%
  mutate(count = as.numeric(gsub(",","",count)))
# Update NSW testing based on this info
oz_testing <- oz_testing %>% 
  mutate(tests = ifelse(state == "NSW", nsw_counts$count[3], tests)) 
nsw_source <- raw_nsw_tbl[[2]] %>% 
  as_tibble() %>% 
  janitor::clean_names()
nsw_demog <- raw_nsw_tbl[[3]]  %>% 
  as_tibble() %>% 
  janitor::clean_names()
```

```{r read-jhu}
# JHU
covid_jh <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
covid_jh_oz_st <- covid_jh %>%
  filter(`Country/Region` == "Australia") %>%
  pivot_longer(cols=contains("/20"), names_to = "date") %>%
  mutate(date = mdy(date)) %>%
  rename(state = `Province/State`) %>%
  mutate(state = recode(state, "New South Wales"="NSW", "Victoria"="VIC", "Queensland"="QLD", 
                        "Australian Capital Territory"="ACT", "South Australia"="SA", 
                        "Western Australia"="WA", "Tasmania"="TAS", "Northern Territory"="NT",
                        "From Diamond Princess"="DP")) %>%
  rename(count = value) %>%
  select(state, date, count) 
# From https://en.wikipedia.org/wiki/List_of_Australian_states_and_territories_by_gross_state_product
state_pop <- tibble(state = c("NSW","VIC","QLD","SA","WA","TAS","NT","ACT","DP"), 
    pop = c(8089526, 6594804, 5095100, 1751693, 2621680, 426709, 245869, 420379, NA))
# Join with Nick Evershed's data
covid_ne_jhu <- left_join(covid_jh_oz_st, d) 
# Add population
covid_ne_jhu <- covid_ne_jhu %>% left_join(state_pop, by="state") %>%
  mutate(state = factor(state, levels = c("NSW", "VIC", "QLD", "SA", "WA", "ACT", "TAS", "NT", "DP")))

# Data fix
# replace the cum_count with jhu number if missing
covid_ne_jhu <- covid_ne_jhu %>%
  mutate(cum_count = ifelse(is.na(cum_count), count, cum_count))
# We'll use the jhu count anyway
# Fill test data with next non-missing
covid_ne_jhu <- covid_ne_jhu %>%
  arrange(state, date)
#covid_ne_jhu_save <- covid_ne_jhu
#covid_ne_jhu <- covid_ne_jhu_save
# Remove DP
covid_ne_jhu <- covid_ne_jhu %>%
  filter(state != "DP") %>%
  mutate(state = factor(state, levels = c("NSW", "VIC", "QLD", "SA", "WA", "ACT", "TAS", "NT")))
pre_n <- 0
for (j in 1:nlevels(covid_ne_jhu$state)) {
  x <- filter(covid_ne_jhu, state == levels(covid_ne_jhu$state)[j])
  n <- nrow(x)
  for (i in 1:n) {
    # Find  nearest date neighbor to fill in missing 
    if (is.na(covid_ne_jhu$tests_tot[i+pre_n])) {
      dst <- abs(as.numeric(covid_ne_jhu$date[i+pre_n]-x$date))
      dst[is.na(x$tests_tot)] <- 1000
      covid_ne_jhu$tests_tot[i+pre_n] <- covid_ne_jhu$tests_tot[which.min(dst)+pre_n]
    }
  }
  pre_n <- pre_n + n
}
# Compute rate, and use the NSW reports
covid_ne_jhu <- covid_ne_jhu %>%
  left_join(oz_testing) %>%
  mutate(state = factor(state, levels = c("NSW", "VIC", "QLD", "SA", "WA", "ACT", "TAS", "NT", "DP"))) %>%
  mutate(rate = count/pop * 100000,
         test_rate = tests/pop * 100000)
# Remove Diamond Princess data
covid_ne_jhu <- covid_ne_jhu %>% filter(state != "DP")
```

```{r eval=FALSE}
# Data from covid-19-au project
state_monash <- fromJSON("https://raw.githubusercontent.com/covid-19-au/covid-19-au.github.io/prod/src/data/state.json")
locations_monash <- fromJSON("https://raw.githubusercontent.com/covid-19-au/covid-19-au.github.io/prod/src/data/mapdata.json")
test_loc_monash <- frmJSON("https://raw.githubusercontent.com/covid-19-au/covid-19-au.github.io/prod/src/data/mapdataHos.json")
```

Australia
=======================================================================


Rates {.sidebar data-width=400}
-----------------------------------------------------------------------

### Rates

Latest incidence and testing rates, per 100,000 people 

```{r test_rate, fig.width=8,  fig.height=4, out.width="100%"}
ord <- covid_ne_jhu %>% 
  filter(date == max(date)) %>%
  arrange(rate) %>%
  select(state)
covid_ne_jhu_smry <- covid_ne_jhu %>% 
  filter(date == max(date)) %>% 
  mutate(count = ifelse(state == "NSW", nsw_counts$count[1], count)) %>%
  mutate(state = factor(state, levels=ord$state))
p1 <- covid_ne_jhu_smry %>%
  ggplot(aes(x=state, y=rate, fill=state)) +
  geom_col() +
  scale_fill_ochre(palette = "mccrea") +
  ggtitle("Incidence") + 
  coord_flip() + xlab("") + ylab("Rate") +
  theme(legend.position = "none")
p2 <- covid_ne_jhu_smry %>%
  ggplot(aes(x=state, y=test_rate, fill=state)) +
  geom_col() +
  scale_fill_ochre(palette = "mccrea") +
  ggtitle("Testing") + 
  coord_flip() + xlab("") + ylab("Rate") +
  theme(legend.position = "none")
grid.arrange(p1, p2, ncol=2)
```

*Note: States ordered by incidence rate.*

### Data

```{r table_counts}
covid_ne_jhu_smry %>% 
  select(state, date, count, tests, source) %>%
  arrange(desc(count)) %>%
  datatable(options = list(
  bPaginate = FALSE
))
```

Column {data-width=600}
-----------------------------------------------------------------------

###  COVID-19 rate per 100,000 people by state in Australia

```{r state_incidence, fig.width=10,  fig.height=5.5}
renderPlot({
  covid_ne_jhu %>% 
  mutate(state = factor(state, levels=ord$state[9:1])) %>%
    ggplot(aes(x=date, y=rate)) +
      geom_point(aes(colour=state)) +
      geom_smooth(se=FALSE, colour="black") + 
      scale_colour_ochre(palette = "mccrea") +
      facet_wrap(~state) + 
      xlab("") + ylab("Rate (per 100k)")
})
```

World Incidence
=======================================================================


Inputs {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r choose_countries}
covid_jh_long <- covid_jh %>%
  pivot_longer(cols=contains("/20"), names_to = "date") %>%
  mutate(date = mdy(date)) %>%
  group_by(date, `Country/Region`) %>%
  summarise(count = sum(value)) %>%
  ungroup() %>%
  group_by(`Country/Region`) %>%
  mutate(daily = count-lag(count, order_by = date)) %>%
  ungroup() %>%
  arrange(`Country/Region`) %>%
  filter(`Country/Region` != "Diamond Princess")
covid_since100 <- covid_jh_long %>%
  filter(count > 100) %>%
  group_by(`Country/Region`) %>%
  mutate(days = as.numeric(date - min(date))) %>%
  ungroup() 
keep <- covid_since100 %>%
  count(`Country/Region`) %>%
  filter(n>14)
covid_since100 <- covid_since100 %>%
  filter(`Country/Region` %in% keep$`Country/Region`)
covid_since100_labels <- covid_since100 %>%
  group_by(`Country/Region`) %>%
  filter(days == max(days)) %>%
  ungroup()
checkboxGroupInput("cnt", "Choose countries:", choices = unique(covid_jh_long$`Country/Region`), selected = c("Australia", "Germany", "Denmark", "Sweden"),  width="100%")
```


Row {data-height=400}
-----------------------------------------------------------------------

```{r incidence_rates, out.height="100%", fig.width=10, fig.height=10}
renderPlot({
china <- filter(covid_since100, `Country/Region`=="China")
china_label <- filter(covid_since100_labels, `Country/Region`=="China")
countries <- covid_since100 %>%
  filter(`Country/Region` %in% input$cnt)
countries_labels <- filter(covid_since100_labels, `Country/Region` %in% input$cnt)
p3 <- 
  ggplot() +
  geom_line(data=china, aes(x=days, y=count), colour="black") +
  geom_text_repel(data=china_label, aes(x=days, y=count, label=`Country/Region`), colour="black") +
  geom_line(data=countries, aes(x=days, y=count, colour=`Country/Region`)) + 
  geom_text_repel(data=countries_labels, aes(x=days, y=count,
       label=`Country/Region`, colour=`Country/Region`)) + 
  scale_y_log10() + 
  xlab("Days since 100 cases") + 
  ylab("Incidences (log scale)") +
  scale_colour_brewer("", palette="Dark2") +
  theme(legend.position = "none") 
p4 <- covid_jh_long %>% 
    filter(`Country/Region` %in% input$cnt) %>%
    ggplot(aes(x=date, y=count)) + geom_col() +
    facet_wrap(~`Country/Region`, scales="free_y") + 
    scale_y_log10() + xlab("") + ylab("Count (log scale)")
grid.arrange(p3, p4, ncol=2)
})
```

Row {data-height=400}
-----------------------------------------------------------------------

### Incidence by country `r max(covid_jh_long$date)`

```{r country_counts}
covid_jh_long %>% 
  filter(date == max(date)) %>%
  select(`Country/Region`, count, daily) %>%
  arrange(`Country/Region`) %>%
  datatable(options = list(
  bPaginate = FALSE
))
```

NOT Mortality rates {data-orientation=columns}
=======================================================================

Column {.sidebar data-width=150}
-----------------------------------------------------------------------
The rates are calculated by taking 1-deaths/incidence. Only countries with more than 500 cases are shown.

<p> *Its more usual to talk about mortality rates, but from a personal perspective, I'd rather not hear about mortality, but rather proportioon of people who are still fighting it or recovered.*

Row {data-height=150}
-----------------------------------------------------------------------

### Counts

```{r read_more_jhu}
covid_jh_deaths <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
covid_jh_recovered <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
```

```{r survival}
covid_jh_deaths_long <- covid_jh_deaths %>%
  pivot_longer(cols=contains("/20"), names_to = "date") %>%
  mutate(date = mdy(date)) %>%
  group_by(date, `Country/Region`) %>%
  summarise(deaths = sum(value)) %>%
  ungroup()
covid_jh_all <- left_join(covid_jh_long, covid_jh_deaths_long)
latest_surv <- covid_jh_all %>%
  select(`Country/Region`, date, count, deaths) %>%
  filter(date == max(date)) %>%
  mutate(survival = 1 - deaths/count) %>%
  filter(!is.na(survival)) %>%
  filter(count > 500)
latest_surv <- latest_surv %>%
  mutate(`Country/Region` = fct_reorder(`Country/Region`, survival))
```

```{r plot-counts, fig.height=7, fig.width=3, out.width="50%"}
p1 <- ggplot(data=latest_surv, aes(x=`Country/Region`, y=count)) +
  geom_col(aes(text=survival)) + 
  scale_y_log10() +
  coord_flip() + xlab("") + ylab("Count (log scale)")
renderPlotly({
  ggplotly(p1)
})
```

Row {data-height=150}
-----------------------------------------------------------------------

### Not mortality

```{r plot_survival, fig.height=7, fig.width=3, out.width="50%"}
p2 <- ggplot(data=latest_surv, aes(x=`Country/Region`, y=survival)) +
  geom_col(aes(text=count)) + 
  coord_flip() + xlab("") + ylab("Survival rate") +
  geom_hline(yintercept=1, colour = "red") +
  ylim(c(0,1))
renderPlotly({
  ggplotly(p2)
})
```


Recovery
=======================================================================

Rates {.sidebar data-width=350}
-----------------------------------------------------------------------

**Exploring the incidence and recovery timeline for China.**

Daily incidence is plotted, along with daily recovered counts. The form looks like many of the epidemic simulation data, for example https://alhill.shinyapps.io/COVID19seir/. 

Row {data-height=150}
-----------------------------------------------------------------------

```{r}
# Examine daily counts and recovery for countries with early outbreaks, eg China
china_count <- covid_jh %>% 
  filter(`Country/Region` == "China") %>%
  pivot_longer(cols=contains("/20"), names_to = "date") %>%
  mutate(date = mdy(date)) %>%
  group_by(date) %>%
  summarise(count = sum(value)) %>%
  ungroup() %>%
  mutate(daily = count - lag(count))
china_recovered <- covid_jh_recovered %>% 
  filter(`Country/Region` == "China") %>%
  pivot_longer(cols=contains("/20"), names_to = "date") %>%
  mutate(date = mdy(date)) %>%
  group_by(date) %>%
  summarise(count = sum(value)) %>%
  ungroup() %>%
  mutate(recovered = count - lag(count))
china <- left_join(china_count, china_recovered, by="date") %>%
  select(-count.x, -count.y) %>%
  pivot_longer(cols = c("daily", "recovered"), names_to = "type", values_to = "count")
ggplot(china, aes(x=date, y=count, colour=type)) + 
  geom_hline(yintercept=0, colour="black") +
  geom_point() + geom_smooth(se=FALSE) +
  scale_colour_brewer("", palette = "Dark2") +
  xlab("") + ylab("Daily counts")
```

Explain
=======================================================================


Data is taken from several sources. 

The incidence data is from John Hopkins University,  https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series. 

This is compared with the  data collated by Nick Evershed on Australian records at https://interactive.guim.co.uk/docsdata/1q5gdePANXci8enuiS4oHUJxcxC13d6bjMRSicakychE.json. 

Population for Australian states is from https://en.wikipedia.org/wiki/List_of_Australian_states_and_territories_by_gross_state_product. 

Testing data for Australia is taken from https://ourworldindata.org/covid-testing. And NSW is updated from https://www.health.nsw.gov.au/news/Pages/20200323_00.aspx. Both of these sites need some manual curation, because one needs a manual download, and the second needs the url updated with the current date, and a check that tables are still the same.

Australian data is sync'd with "The Real-time COVID-19 Status in Australia" https://github.com/covid-19-au/covid-19-au.github.io. This data is sourced from media reports and is curated by a team at Monash University. 

All code is available at https://github.com/dicook/covid19. Suggestions and pull requests encouraged. 

